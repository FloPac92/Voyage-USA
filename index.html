<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Road Trip USA 2026</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  
  <!-- Custom styles -->
  <style>
    /* Menu styling */
    .day-button {
      width: 100%;
      padding: 0.5rem 1rem;
      text-align: left;
      border-radius: 0.5rem;
      transition: all 0.2s;
    }
    .day-button:hover {
      background-color: #eff6ff;
    }
    .day-button.active {
      background-color: #2563eb;
      color: white;
    }
    
    /* Timeline styling */
    .timeline-item::before {
      content: '';
      position: absolute;
      width: 1rem;
      height: 1rem;
      background-color: #3b82f6;
      border: 2px solid #fff;
      box-shadow: 0 0 0 2px #3b82f6;
      border-radius: 9999px;
      left: -28px;
      margin-top: 0.5rem;
    }
    
    .timeline-item::after {
      content: '';
      position: absolute;
      width: 2px;
      height: calc(100% + 1rem);
      background-color: #e5e7eb;
      left: -24px;
      top: 1rem;
      z-index: -1;
    }
    
    .timeline-item:last-child::after {
      display: none;
    }
    
    /* Mobile menu */
    @media (max-width: 768px) {
      .side-nav {
        position: fixed;
        inset: 0;
        z-index: 40;
        transform: translateX(-100%);
        transition: transform 0.3s ease-in-out;
      }
      .side-nav.show {
        transform: translateX(0);
      }
    }
    
    /* Map marker styles */
    .custom-marker {
      width: 20px;
      height: 20px;
      background-color: #2563eb;
      border: 2px solid white;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
    }
    
    .custom-marker.active {
      background-color: #dc2626;
      transform: scale(1.2);
    }
    
    /* Custom popup styles */
    .custom-popup .leaflet-popup-content-wrapper {
      background: white;
      color: #1f2937;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .custom-popup .leaflet-popup-content {
      margin: 8px 12px;
      min-width: 200px;
    }
    
    .custom-popup .leaflet-popup-tip {
      background: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .custom-popup .leaflet-popup-close-button {
      padding: 8px;
      color: #4b5563;
      font-weight: bold;
      font-size: 16px;
    }
    
    .marker-popup h3 {
      color: #1f2937;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .marker-popup .text-gray-700 {
      line-height: 1.5;
    }

    /* Photo lightbox */
    .lightbox {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .lightbox.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <!-- Header -->
  <header class="sticky top-0 bg-white shadow-lg z-40">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex items-center justify-between h-16">
        <h1 class="text-xl font-bold">Road Trip USA 2026</h1>
        
        <!-- Mobile menu button -->
        <button id="mobile-menu-button" class="md:hidden p-2" aria-label="Menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Map section -->
  <section id="map" class="h-[400px] relative z-0">
    <div id="map-container" class="w-full h-full"></div>
  </section>

  <!-- Main content -->
  <main class="min-h-screen relative">
    <div class="flex">
      <!-- Side navigation -->
      <nav id="side-nav" class="w-72 bg-white shadow-lg h-[calc(100vh-200px)] sticky top-16 overflow-y-auto hidden md:block">
        <div class="p-6">
          <div class="text-2xl font-bold mb-6 text-blue-600">Programme du voyage</div>
          <div id="days-nav" class="space-y-2">
            <!-- Days navigation will be inserted here -->
          </div>
        </div>
      </nav>

      <!-- Main content area -->
      <div class="flex-1">
        <div id="day-content" class="max-w-7xl mx-auto p-6">
          <div class="flex flex-col md:flex-row md:space-x-8">
            <!-- Left column: Content -->
            <div class="flex-1 px-8">
              <!-- Title and info -->
              <div class="mb-8">
                <h2 id="day-title" class="text-4xl font-bold mb-6 text-blue-800"></h2>
                
                <!-- Travel info icons -->
                <div class="inline-flex items-center gap-8 px-6 py-4 bg-blue-50 rounded-lg mb-8">
                  <div class="flex items-center">
                    <span class="text-2xl mr-3 text-blue-500">‚è∞</span>
                    <span id="wake-up" class="text-blue-700"></span>
                  </div>
                  <div class="flex items-center">
                    <span class="text-2xl mr-3 text-blue-500">üè®</span>
                    <span id="sleep" class="text-blue-700"></span>
                  </div>
                  <div class="flex items-center">
                    <span class="text-2xl mr-3 text-blue-500">üöó</span>
                    <span id="distance" class="text-blue-700"></span>
                  </div>
                </div>

                <!-- Activities -->
                <div class="prose max-w-none">
                  <div id="activities-list" class="space-y-6 pl-8">
                    <!-- Activities will be inserted here -->
                  </div>
                </div>
              </div>
            </div>

            <!-- Right column: Photo -->
            <div class="md:w-1/3 md:sticky md:top-24">
              <div id="photos-grid" class="sticky top-24">
                <!-- Photos will be inserted here -->
              </div>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Photo lightbox -->
  <div id="lightbox" class="lightbox">
    <img id="lightbox-img" class="max-h-[90vh] max-w-[90vw] object-contain" src="" alt="">
    <button class="absolute top-4 right-4 text-white text-4xl" onclick="closeLightbox()">&times;</button>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Omnivore for KML -->
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    // Global variables
    let currentDay = 1;
    let map;
    const markerManager = {
      markers: new Map(),
      addMarker(day, marker) {
        this.markers.set(day, marker);
        console.log(`Marker added for day ${day}. Total markers: ${this.markers.size}`);
      },
      getMarker(day) {
        return this.markers.get(day);
      },
      resetAllMarkers() {
        this.markers.forEach((marker, day) => {
          marker.setIcon(this.createIcon(false));
        });
      },
      createIcon(isActive) {
        return L.divIcon({
          className: '',
          html: `<div class="custom-marker${isActive ? ' active' : ''}"></div>`,
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
      }
    };
    
    // Initialize map
    async function initMap() {
      // Charger les donn√©es des jours et des points de carte
      window.tripData = await loadDayData();
      window.mapPoints = await loadMapData();

      map = L.map('map-container').setView([36.17, -115.90], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Cr√©er les marqueurs depuis map_data.json
      if (Array.isArray(window.mapPoints)) {
        window.mapPoints.forEach(point => {
          const marker = L.marker([point.lat, point.lng], {
            icon: markerManager.createIcon(false)
          }).addTo(map);
          markerManager.addMarker(point.day, marker);
          const popupContent = `
            <div class="marker-popup">
              <h3 class="font-bold text-lg mb-2">${point.title}</h3>
              <div class="text-gray-700">Jour ${point.day}</div>
            </div>
          `;
          marker.bindPopup(popupContent, { className: 'custom-popup' });
          marker.bindTooltip(`Jour ${point.day}`, { direction: 'top', sticky: true });
          marker.on('mouseover', () => marker.openTooltip());
          marker.on('mouseout', () => marker.closeTooltip());
          marker.on('click', function() {
            markerManager.markers.forEach((m, d) => {
              if (m !== marker) m.closePopup();
            });
            marker.openTooltip();
            showDay(point.day);
            const navBtn = document.querySelector(`.day-button[data-day="${point.day}"]`);
            if (navBtn) {
              document.querySelectorAll('.day-button').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.day, 10) === point.day);
              });
              navBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
          });
        });
      }

      // Charger le trac√© KML (sans les points, d√©j√† g√©r√©s)
      console.log('Loading KML file...');
      omnivore.kml('./itinary.kml')
        .on('ready', async function() {
          console.log('KML file loaded successfully');
          this.eachLayer(function(layer) {
            if (layer.feature && layer.feature.geometry.type === 'Point') {
              map.removeLayer(layer);
            } else {
              layer.setStyle({
                color: '#2563eb',
                weight: 3,
                opacity: 1
              });
            }
          });
          this.addTo(map);
          map.fitBounds(this.getBounds());
          if (window.tripData) {
            renderNavigation(window.tripData);
            await showDay(1);
          }
        })
        .on('error', function(error) {
          console.error('Error loading KML:', error);
        });
    }

    // Load day data
    async function loadDayData() {
      try {
        console.log('Fetching Itineraire_RoadTripUSA2026.json...');
        const response = await fetch('./Itineraire_RoadTripUSA2026.json');
        console.log('Response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const text = await response.text();
        console.log('Response text:', text.substring(0, 100) + '...');
        let data = JSON.parse(text);
        
        // Ajouter le num√©ro du jour √† chaque √©l√©ment
        if (Array.isArray(data)) {
          data = data.map((item, index) => {
            // Extraire le num√©ro du jour de la propri√©t√© 'jour'
            const dayMatch = item.jour.match(/Jour (\d+)/);
            const day = dayMatch ? parseInt(dayMatch[1]) : index + 1;
            return { ...item, day };
          });
        } else if (typeof data === 'object') {
          // Si c'est un objet, le convertir en tableau
          data = Object.values(data).map((item, index) => {
            const dayMatch = item.jour.match(/Jour (\d+)/);
            const day = dayMatch ? parseInt(dayMatch[1]) : index + 1;
            return { ...item, day };
          });
        }
        console.log('Processed trip data:', data);
        return data;
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('day-content').innerHTML = `
          <div class="text-red-600 p-4">
            Erreur de chargement : ${error.message}
          </div>
        `;
        return null;
      }
    }

    // Load map points data
    async function loadMapData() {
      try {
        console.log('Fetching map_data.json...');
        const response = await fetch('./map_data.json');
        console.log('Map data response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const text = await response.text();
        console.log('Map data response text:', text.substring(0, 100) + '...');
        return JSON.parse(text);
      } catch (error) {
        console.error('Error loading map data:', error);
        return [];
      }
    }

    // Load detailed day info
    async function loadDetailedDayInfo(dayNumber) {
      try {
        console.log('Loading detailed info for day:', dayNumber);
        if (!window.detailedData) {
          console.log('Fetching Fiches_Jours_1_a_16_RoadTripUSA2026.json...');
          const response = await fetch('./Fiches_Jours_1_a_16_RoadTripUSA2026.json');
          console.log('Detailed data response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const text = await response.text();
          console.log('Detailed data response text:', text.substring(0, 100) + '...');
          window.detailedData = JSON.parse(text);
        }
        console.log('Detailed data for day', dayNumber, ':', window.detailedData[dayNumber - 1]);
        return window.detailedData[dayNumber - 1];
      } catch (error) {
        console.error('Error loading detailed data:', error);
        throw error; // Propager l'erreur pour une meilleure gestion
      }
    }

    // Render navigation
    function renderNavigation(data) {
      const nav = document.getElementById('days-nav');
      nav.innerHTML = data.map(day => `
        <button
          class="day-button ${currentDay === day.day ? 'active' : ''}"
          data-day="${day.day}"
          onclick="showDay(${day.day})"
        >
          ${day.jour}
        </button>
      `).join('');
    }

    // Show day content
    async function showDay(dayNumber) {
      try {
        // S'assurer que le num√©ro de jour est bien un entier
        const dayNum = parseInt(dayNumber, 10);
        console.log('Showing day:', dayNum);
        console.log('Current tripData:', window.tripData);
        currentDay = dayNum;

        // Recherche du jour par son num√©ro
        const day = window.tripData.find(d => d.day === dayNum);
        console.log('Found day:', day);
        
        if (!day) {
          console.error('Day not found in tripData:', dayNumber);
          console.log('Available days:', window.tripData.map(d => d.day));
          return;
        }

        // Update navigation
        document.querySelectorAll('.day-button').forEach(btn => {
          btn.classList.toggle('active', parseInt(btn.dataset.day, 10) === dayNum);
        });
        const activeBtn = document.querySelector(`.day-button[data-day="${dayNum}"]`);
        if (activeBtn) {
          activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Load detailed day info
        const detailedInfo = await loadDetailedDayInfo(dayNum);
        if (!detailedInfo) {
          throw new Error('Detailed info not available for day ' + dayNumber);
        }

      // Update content
      document.getElementById('day-title').textContent = detailedInfo.jour;
      document.getElementById('wake-up').textContent = detailedInfo.description.split('\n')[0].replace('R√©veil : ', '');
      document.getElementById('sleep').textContent = detailedInfo.description.split('\n')[1].replace('Coucher : ', '');
      document.getElementById('distance').textContent = detailedInfo.description.split('\n')[2].replace('Trajet : ', '');

      // Update description
      const description = `
        <div class="mb-6 text-gray-700">
          ${detailedInfo.explication}
        </div>
      `;

      // Update timeline
      const timeline = `
        <div class="space-y-4">
          ${detailedInfo.agenda.map(item => {
            const [time, activity] = item.split(' : ');
            return `
              <div class="timeline-item relative pl-4">
                <div class="flex items-start">
                  <span class="text-blue-600 font-medium w-32 shrink-0">${time}</span>
                  <span class="text-gray-700">${activity}</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      // Update activities list
      const activitiesList = document.getElementById('activities-list');
      activitiesList.innerHTML = description + timeline;

      // Update photos
      const photosGrid = document.getElementById('photos-grid');
      photosGrid.innerHTML = `
        <img
          src="jour${day.day}${day.day === 1 ? '.jpg' : '.png'}"
          alt="${detailedInfo.photo}"
          class="w-full h-[calc(100vh-200px)] object-cover rounded-lg cursor-pointer hover:opacity-90 transition-opacity shadow-lg"
          onclick="openLightbox('jour${day.day}${day.day === 1 ? '.jpg' : '.png'}')"
          onerror="this.style.display='none'"
        >
      `;

      // Update map
      updateMapMarker(day);
    } catch (error) {
      console.error('Error showing day:', error);
      document.getElementById('day-content').innerHTML = `
        <div class="text-red-600 p-4">
          Erreur lors du chargement du jour ${dayNumber}: ${error.message}
        </div>
      `;
    }
}

    // Helper function to create marker icons
    function createMarkerIcon(isActive = false) {
      return L.divIcon({
        className: isActive ? 'marker-active' : 'marker-default',
        html: `<div class="marker-${isActive ? 'active' : 'default'}"></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
      });
    }

    // Update map marker
    function updateMapMarker(day) {
      try {
        if (!day || !day.day) {
          console.error('Invalid day object:', day);
          return;
        }
        const activeMarker = markerManager.getMarker(day.day);
        if (!activeMarker) {
          console.error('No marker found for day:', day.day);
          return;
        }
        // R√©initialiser tous les marqueurs et activer le marqueur actif
        markerManager.resetAllMarkers();
        activeMarker.setIcon(markerManager.createIcon(true));
        // Centrer la carte sur le marqueur actif avec animation
        const latlng = activeMarker.getLatLng();
        map.flyTo(latlng, 10, { animate: true, duration: 1 });
        // Fermer tous les popups puis ouvrir celui du marqueur actif
        markerManager.markers.forEach(m => m.closePopup());
        setTimeout(() => {
          activeMarker.openPopup();
          activeMarker.openTooltip();
        }, 500);
      } catch (error) {
        console.error('Error updating active marker:', error);
      }
    }

    // Lightbox functions
    function openLightbox(src) {
      document.getElementById('lightbox').classList.add('active');
      document.getElementById('lightbox-img').src = src;
    }

    function closeLightbox() {
      document.getElementById('lightbox').classList.remove('active');
    }

    // Mobile menu
    document.getElementById('mobile-menu-button').addEventListener('click', () => {
      const nav = document.getElementById('side-nav');
      nav.classList.toggle('hidden');
    });

    // Initialize
    window.addEventListener('load', async () => {
      console.log('Loading application...');
      
      try {
        // Verify Tailwind is loaded
        console.log('Tailwind loaded:', typeof tailwind !== 'undefined');
        
        // Initialize map
        console.log('Initializing map...');
        await initMap();  // Attend que la carte soit initialis√©e avec les donn√©es
        
        // Donn√©es d√©j√† charg√©es dans initMap
        console.log('Trip data loaded:', window.tripData);
        console.log('Trip data loaded:', window.tripData);
        
        // La navigation et l'affichage du jour 1 sont maintenant g√©r√©s apr√®s le chargement du KML
        if (!window.tripData) {
          document.getElementById('day-content').innerHTML = `
            <div class="text-red-600 p-4">
              Erreur: Impossible de charger les donn√©es du voyage.
              V√©rifiez que le fichier Itineraire_RoadTripUSA2026.json est pr√©sent.
            </div>
          `;
        }
      } catch (error) {
        console.error('Error during initialization:', error);
        document.getElementById('day-content').innerHTML = `
          <div class="text-red-600 p-4">
            Erreur lors de l'initialisation: ${error.message}
          </div>
        `;
      }
    });
  </script>
</body>
</html>
